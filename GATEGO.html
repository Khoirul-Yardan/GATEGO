<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pelabuhan Suite - Alur Dua Gerbang & Kamera</title>
<style>
  :root{--bg:#f7f9fc; --panel:#ffffff; --muted:#555; --text:#1a1a1a; --accent:#2b7de9; --ok:#1e9e55; --warn:#e69500; --err:#d43f3a; --line:#cfd9e4;}
  *{box-sizing:border-box}
  html,body{min-height:100%}
  body{ margin:0; font:16px/1.6 "Segoe UI", Arial, sans-serif; color:var(--text); background:var(--bg); }
  a{color:inherit; text-decoration:none}
  .wrap{max-width:1400px; margin:24px auto; padding:0 16px}
  .topbar{display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; padding:16px 20px; border:2px solid var(--line); border-radius:14px; background:var(--panel); position:sticky; top:12px; z-index:5;}
  .brand{display:flex; gap:12px; align-items:center; font-weight:700; font-size:18px}
  .brand .logo{inline-size:42px; block-size:42px; border-radius:9px; background:var(--accent); display:grid; place-items:center; color:white; font-weight:900; font-size:18px;}
  .tabs{display:flex; gap:10px; flex-wrap:wrap}
  .tab-btn{padding:12px 18px; border:2px solid var(--line); border-radius:12px; background:#f2f6fb; color:var(--text); cursor:pointer; font-weight:600; font-size:15px;}
  .tab-btn[aria-selected="true"]{background:var(--accent); color:#fff; border-color:var(--accent)}
  .tab-btn:hover{background:#e6efff}
  .content{margin-top:20px}
  .grid{display:grid; gap:16px}
  .g-3{grid-template-columns:repeat(3,1fr)}
  .g-2{grid-template-columns:repeat(2,1fr)}
  @media (max-width:1200px){ .g-3{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:800px){ .g-3,.g-2{grid-template-columns:1fr} }
  .card{ background:var(--panel); border:2px solid var(--line); border-radius:14px; padding:18px; display: flex; flex-direction: column;}
  .card h3{margin:0 0 10px 0; font-size:17px; color:#0056a6}
  .card .table-wrap{flex-grow:1; overflow-x:auto;}
  .muted{color:var(--muted)}
  .badge{ font-size:14px; padding:6px 10px; border-radius:999px; font-weight:600; display:inline-block; }
  .badge.ok{background:#dff5e8; color:var(--ok)}
  .badge.warn{background:#fff3d6; color:var(--warn)}
  .badge.err{background:#fbe3e4; color:var(--err)}
  .badge.info{background:#e6efff; color:var(--accent)}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding-top: 8px;}
  .input, .select, textarea{background:#fff; border:2px solid var(--line); color:var(--text); padding:10px 14px; border-radius:10px; outline:none; font-size:15px; width:100%;}
  .btn{padding:12px 18px; border-radius:10px; background:var(--accent); color:#fff; border:0; cursor:pointer; font-weight:700; font-size:15px; text-align: center;}
  .btn.ghost{background:#f0f3f9; border:2px solid var(--line); color:#0056a6}
  .btn.warn{background:var(--warn); color:#fff}
  .btn.err{background:var(--err); color:#fff}
  .btn.ok{background:var(--ok); color:#fff}
  .btn.small{padding:8px 12px; font-size:14px}
  table{width:100%; border-collapse:collapse; font-size:15px}
  th,td{padding:12px; border:1px solid var(--line); vertical-align:top; text-align: left;}
  th{background:#f0f3f9; font-weight:700; color:#003366}
  tr:hover td{background:#f9fbff}
  .rows{display:flex; flex-direction:column; gap:12px}
  .cols{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
  .label{font-size:14px; color:#333; margin-bottom: -4px;}
  .foot{margin-top:20px; text-align:center; color:var(--muted); font-size:13px}
  .hide{display:none !important}
  .login-wrap{max-width:520px; margin:40px auto}
  .role-chip{display:flex; gap:10px; flex-wrap:wrap}
  .chip{padding:8px 12px; border:2px solid var(--line); border-radius:999px; cursor:pointer; background:#fff}
  .chip[aria-pressed="true"]{background:#e6efff; border-color:#9ec3ff}
  /* LCL Item Styling */
  .item-entry{padding:10px; border:1px dashed var(--line); border-radius:8px; background:#fbfcfe;}
  .item-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px 12px;}
  .item-grid .span-2{grid-column: span 2;}
  /* Inline camera view styling */
  .inline-camera-view{
    border:2px solid var(--line); border-radius:12px; overflow:hidden;
    background:#eef2f7; position:relative; min-height:150px; margin-top: 5px;
  }
  .inline-camera-view video{width:100%; display:block; background:#000;}
  .inline-camera-view .status{
    position:absolute; top:8px; left:8px; background:rgba(255,255,255,0.8);
    backdrop-filter:blur(4px); padding:4px 8px; border-radius:8px; font-size:13px; font-weight:600;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <span class="brand"><span class="logo">G</span> Admin Pelabuhan</span>
    <button id="btn-logout" class="btn ghost">Logout</button>
  </div>

  <div class="content grid g-2">
    <!-- Kamera Gate OCR -->
    <div class="card">
      <h3>Kamera Gate OCR</h3>
      <video id="admin-camera-feed-1" class="inline-camera-view" autoplay muted playsinline></video>
      <div id="admin-camera-status-1" class="muted">Offline</div>
    </div>
    <!-- Kamera Gate Utama -->
    <div class="card">
      <h3>Kamera Gate Utama</h3>
      <video id="admin-camera-feed-2" class="inline-camera-view" autoplay muted playsinline></video>
      <div id="admin-camera-status-2" class="muted">Offline</div>
    </div>
  </div>

  <div class="content">
    <div class="card">
      <h3>Simulasi Kedatangan Truk</h3>
      <div class="toolbar">
        <button id="btn-simulate-ocr-valid" class="btn ok">Simulasi OCR Valid</button>
        <button id="btn-simulate-ocr-invalid" class="btn warn">Simulasi OCR Tidak Valid</button>
      </div>
      <div id="barcode-modal" class="card hide" style="position:fixed; left:0; top:0; right:0; margin:auto; max-width:400px; z-index:99; background:#fff;">
        <h4>Scan Barcode Surat Jalan</h4>
        <input id="barcode-input" class="input" placeholder="Masukkan kode barcode..." />
        <div class="toolbar">
          <button id="btn-barcode-validate" class="btn ok">Validasi</button>
          <button id="btn-barcode-cancel" class="btn err">Batal</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Data Truk/Kontainer & Status Proses</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>No. Kontainer</th>
              <th>No. Polisi Truk</th>
              <th>Status</th>
              <th>Aksi</th>
              <th>Log & Pajak</th>
            </tr>
          </thead>
          <tbody id="admin-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Helper selector
function $(sel) {
  return document.querySelector(sel);
}

// Dummy database kontainer valid
const DB_CONTAINERS = [
  { number: "MSCU 123456 7", truck: "B 1234 XYZ" },
  { number: "TGHU 987654 3", truck: "D 5678 ABC" }
];

const KEYS = { items: 'gatego_v4_items' };
const getItems = () => JSON.parse(localStorage.getItem(KEYS.items) || '[]');
const setItems = v => localStorage.setItem(KEYS.items, JSON.stringify(v));

// Simulasi kamera (dummy)
function startAdminCameras() {
  $('#admin-camera-status-1').textContent = 'Online';
  $('#admin-camera-status-2').textContent = 'Online';
  // Realtime webcam untuk demo
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
      $('#admin-camera-feed-1').srcObject = stream;
      $('#admin-camera-feed-2').srcObject = stream;
    }).catch(function(e){
      $('#admin-camera-status-1').textContent = 'Webcam gagal';
      $('#admin-camera-status-2').textContent = 'Webcam gagal';
    });
  }
}
startAdminCameras();

// Simulasi OCR valid
$('#btn-simulate-ocr-valid').addEventListener('click', () => {
  const db = DB_CONTAINERS[0];
  const pajak = hitungPajakImpor({
    fob_usd: 5000,
    freight_usd: 500,
    insurance_usd: 50,
    tarif_bea_masuk: 0.05,
    kurs_pajak: 16000,
    biaya_clearance: 150,
    biaya_trucking: 100,
    biaya_storage: 75,
    punya_npwp: true
  });
  const item = {
    id: 'ID' + Math.random().toString(36).slice(2, 9),
    number: db.number,
    truck: db.truck,
    status: 'ocr_valid',
    pajak: pajak,
    log: [{ time: new Date().toISOString(), message: 'OCR berhasil, data valid. Palang Gate 1 terbuka otomatis.' }]
  };
  const items = getItems();
  items.push(item);
  setItems(items);
  renderAdminTable();
});

// Simulasi OCR tidak valid
$('#btn-simulate-ocr-invalid').addEventListener('click', () => {
  const pajak = hitungPajakImpor({
    fob_usd: 4000,
    freight_usd: 400,
    insurance_usd: 40,
    tarif_bea_masuk: 0.05,
    kurs_pajak: 16000,
    biaya_clearance: 100,
    biaya_trucking: 80,
    biaya_storage: 50,
    punya_npwp: false
  });
  const item = {
    id: 'ID' + Math.random().toString(36).slice(2, 9),
    number: 'TEMU 654321 1',
    truck: 'F 4321 DEF',
    status: 'ocr_invalid',
    pajak: pajak,
    log: [{ time: new Date().toISOString(), message: 'OCR gagal/tidak lengkap. Truk berhenti di Gate Utama.' }]
  };
  const items = getItems();
  items.push(item);
  setItems(items);
  renderAdminTable();
});

// Barcode modal logic
window.showBarcodeModal = function(id) {
  $('#barcode-modal').classList.remove('hide');
  $('#barcode-modal').dataset.id = id;
}
$('#btn-barcode-cancel').addEventListener('click', () => {
  $('#barcode-modal').classList.add('hide');
  $('#barcode-input').value = '';
});
$('#btn-barcode-validate').addEventListener('click', () => {
  const id = $('#barcode-modal').dataset.id;
  const code = $('#barcode-input').value.trim();
  if (!code) { alert('Masukkan kode barcode!'); return; }
  const items = getItems();
  const item = items.find(it => it.id === id);
  // Barcode valid jika cocok dengan salah satu DB_CONTAINERS
  const valid = DB_CONTAINERS.some(db => db.number === item.number && db.truck === item.truck);
  if (valid) {
    item.status = 'manual_valid';
    item.log.push({ time: new Date().toISOString(), message: 'Barcode valid, palang Gate Utama terbuka.' });
  } else {
    item.log.push({ time: new Date().toISOString(), message: 'Barcode tidak valid, akses ditolak.' });
  }
  setItems(items);
  $('#barcode-modal').classList.add('hide');
  $('#barcode-input').value = '';
  renderAdminTable();
});

// Tambahkan di dalam <script> sebelum renderAdminTable
function hitungPajakImpor({
  fob_usd,
  freight_usd,
  insurance_usd,
  tarif_bea_masuk,
  tarif_ppn = 0.11,
  tarif_pph_npwp = 0.025,
  kurs_pajak = 16000,
  punya_npwp = true,
  biaya_clearance = 0,
  biaya_trucking = 0,
  biaya_storage = 0
}) {
  const cif = fob_usd + freight_usd + insurance_usd;
  const bea_masuk = cif * tarif_bea_masuk;
  const dpp = cif + bea_masuk;
  const ppn = dpp * tarif_ppn;
  const tarif_pph = punya_npwp ? tarif_pph_npwp : 0.075;
  const pph_22 = dpp * tarif_pph;
  const total_pajak = bea_masuk + ppn + pph_22;
  const landed_cost_usd = cif + total_pajak + biaya_clearance + biaya_trucking + biaya_storage;
  const landed_cost_idr = landed_cost_usd * kurs_pajak;
  return {
    "CIF (USD)": cif,
    "Bea Masuk (USD)": bea_masuk,
    "DPP (USD)": dpp,
    "PPN (USD)": ppn,
    "PPh 22 (USD)": pph_22,
    "Total Pajak (USD)": total_pajak,
    "Total Landed Cost (USD)": landed_cost_usd,
    "Total Landed Cost (IDR)": landed_cost_idr
  };
}

// Render tabel admin
function renderAdminTable() {
  const items = getItems();
  const tbody = $('#admin-table-body');
  tbody.innerHTML = '';
  items.forEach(item => {
    let statusText = '';
    let aksiBtn = '';
    if (item.status === 'ocr_valid') {
      statusText = '<span class="badge ok">Lolos OCR (Gate 1 terbuka)</span>';
      aksiBtn = '-';
    } else if (item.status === 'ocr_invalid') {
      statusText = '<span class="badge err">Gagal OCR (Scan Barcode)</span>';
      aksiBtn = `<button class="btn small ok" onclick="showBarcodeModal('${item.id}')">Scan Barcode</button>`;
    } else if (item.status === 'manual_valid') {
      statusText = '<span class="badge ok">Barcode Valid (Gate 2 terbuka)</span>';
      aksiBtn = '-';
    }
    // Pajak info
    let pajakHtml = '';
    if (item.pajak) {
      pajakHtml = Object.entries(item.pajak).map(([k, v]) => `<div>${k}: <b>${v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</b></div>`).join('');
    }
    const logHtml = item.log.map(l => `<div>${new Date(l.time).toLocaleString()}<br>${l.message}</div>`).join('');
    tbody.innerHTML += `<tr>
      <td>${item.number}</td>
      <td>${item.truck}</td>
      <td>${statusText}</td>
      <td>${aksiBtn}</td>
      <td>${logHtml}${pajakHtml ? '<hr>'+pajakHtml : ''}</td>
    </tr>`;
  });
}
renderAdminTable();

// Logout
$('#btn-logout').addEventListener('click', () => {
  localStorage.removeItem(KEYS.items);
  location.reload();
});
</script>
</body>
</html>